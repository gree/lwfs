(function(g){function J(a){a="useCanvasRenderer"===a||"useWebGLRenderer"===a?document.createElement("canvas"):document.createElement("div");a.width=a.height=0;return a}function k(){this.initializeHooks=[];this.requests=[];this.gotoRewind=this.pausing=!1;this.loadingCounter=0;this.debug=!1;this.resizeMode=this.backgroundColor=null;this.fitToScreen=!1;this.displayDivId=null;this.screenHeight=this.screenWidth=this.stageHeight=this.stageWidth=0;this.stageVAlign=this.stageHAlign=-1;this.useDefaultImgPath=
this.useAbsImagePath=this.useWebGL=this.useLargeImage=!1;this.isPreventDefaultEnabled=D||/Android *(4|3)\..*/.test(n);this.rootOffset={x:0,y:0};var a=null,h=0;this.getRenderer=function(){return a};this.setRenderer=function(f){if(a)throw Error("cannot use multiple renderer! LWF has been initialized for "+a+" renderer.");"canvas"===f?f="useCanvasRenderer":"webkitcss"===f?f="useWebkitCSSRenderer":"webgl"===f&&(f="useWebGLRenderer");f&&f.match(/use.+Renderer/i)&&(a=f)};this.getCurrentFPS=function(){isNaN(h)&&
console.error("[LWF] FPS is not properly defined");return h};this.setCurrentFPS=function(a){isNaN(a)&&console.error("[LWF] FPS is not properly defined");h=a};return this}var n=navigator.userAgent,D=/iP(ad|hone|od)/.test(n),w=/Android/.test(n),t=D||w,H=/Chrome/.test(n),x=!w||H,z=0;"undefined"===typeof g.performance&&(g.performance={});g.performance.now=g.performance.now||g.performance.webkitNow||g.performance.mozNow||g.performance.oNow||g.performance.msNow||Date.now;g.requestAnimationFrame=g.requestAnimationFrame||
g.webkitRequestAnimationFrame||g.mozRequestAnimationFrame||g.oRequestAnimationFrame||g.msRequestAnimationFrame;(void 0===g.requestAnimationFrame||/iP(ad|hone|od).*OS 6/.test(n))&&function(){var a=1E3/60,h=g.performance.now();g.requestAnimationFrame=function(f){var c=g.performance.now()-h;return g.setTimeout(function(){h=g.performance.now();f()},a-(c>a?c%a:c))}}();k.prototype.isLwfsEnvironment_=function(){return g.testlwf_settings&&!this.isLwfsLoaderEnvironment_()};k.prototype.isLwfsLoaderEnvironment_=
function(){return g.lwfs_loader_mode};k.prototype.setPreventDefaultBehaviour=function(a){this.isPreventDefaultEnabled=a};k.prototype.addInitializeHook=function(a){_.isFunction(a)&&this.initializeHooks.push(a)};k.prototype.pause=function(){this.pausing=!0};k.prototype.resume=function(){this.pausing=!1};k.prototype.rewind=function(){this.gotoRewind=!0};k.prototype.getLwfMapper_=function(a){if(null===a.lwfMap)return _.bind(this.getLwfPath_,this);var h=a.lwfMap;if(_.isObject(h))return _.isFunction(h)?
h:function(a){var c=a;h.hasOwnProperty(a)&&(c=h[a]);/\.lwf$/.test(c)||(c+=".lwf");return c};throw Error("unsupported lwfMap");};k.prototype.getLwfPath_=function(a){var h=a;0<=a.indexOf("/")&&(h=a.substring(a.lastIndexOf("/")+1));return this.isLwfsEnvironment_()||this.isLwfsLoaderEnvironment_()?h+".lwf":a+"/_/"+h+".lwf"};k.prototype.getImageMapper_=function(a){return _.isFunction(a)?a:function(h){return a[h]?a[h]:h}};k.prototype.autoSelectRenderer_=function(){if(this.useWebGL)for(var a=document.createElement("canvas"),
h=["webgl","experimental-webgl","moz-webgl","webkit-3d"],f,c=0;c<h.length;c++)if(f=a.getContext(h[c]))return"useWebGLRenderer";return/iP(ad|hone|od).*OS 4/.test(n)||/Android 2\.1/.test(n)||/Android 2\.3\.[5-7]/.test(n)||/Android 4/.test(n)&&!/Chrome/.test(n)?"useWebkitCSSRenderer":"useCanvasRenderer"};k.prototype.setDisplaySetting=function(a){a.renderer&&this.setRenderer(a.renderer);this.resizeMode=a.resizeMode||this.resizeMode;this.displayDivId=a.displayDivId||this.displayDivId;this.stageWidth=a.stageWidth||
this.stageWidth;this.stageHeight=a.stageHeight||this.stageHeight;this.screenWidth=a.screenWidth||this.screenWidth;this.screenHeight=a.screenHeight||this.screenHeight;this.stageHAlign="undefined"!==typeof a.stageHAlign?a.stageHAlign:this.stageHAlign;this.stageVAlign="undefined"!==typeof a.stageHAlign?a.stageVAlign:this.stageVAlign;this.useLargeImage=a.useLargeImage||this.useLargeImage};k.prototype.handleException_=function(a,h){var f=h.pageTransitionMap,c=null;f.hasOwnProperty("error")?c=f.error:0<
_.size(f)&&(c=_.find(f,function(){return!0}));f=h.handler;null===f||void 0===f.exception?confirm("LWF exception. \n"+a.stack+"\n reload?")&&location.reload():_.isFunction(f.exception)&&f.exception(a,c);console.error("[LWF] exception: %s",a.stack)};k.prototype.handleLoadError_=function(a,h){var f=h.pageTransitionMap,c=null;f.hasOwnProperty("error")?0<_.size(f)&&(c=_.find(f,function(){return!0})):c=f.error;f=h.handler;null===f||void 0===f.loadError?confirm("LWF load error. \n reload?")&&location.reload():
_.isFunction(f.loadError)&&f.loadError(a,c);console.error("[LWF] load error: %o",a.error);console.error("[LWF] loaded count: %d/%d",a.loadedCount,a.total)};k.prototype.onLoad=function(a){var h=this,f=h.privateData._loaderData,c=f.loader,b=f.stageEventReceiver;h.privateData=null;if(a){if(_.isFunction(f.callback.onLoad))f.callback.onLoad(a);var e,d,y,k,u,l=this.stage,I=0,x=0,v=1,q=0,r=0,E=g.performance.now(),F=0,z=E,G=0;a.rootMovie.moveTo(c.rootOffset.x,c.rootOffset.y);g.lwfs_loader_mode||(a.width=
c.stageWidth?c.stageWidth:a.width,a.height=c.stageHeight?c.stageHeight:a.height);g.lwfWidth=a.width;g.lwfHeight=a.height;var B=g.devicePixelRatio;"useWebkitCSSRenderer"===c.getRenderer()&&(B=1);"useWebGLRenderer"===c.getRenderer()&&/ F-/.test(n)&&(B=2);"useWebkitCSSRenderer"===c.getRenderer()&&/Android 2\.3\.[5-7]/.test(n)&&/SH/.test(n)&&(this.stage.style.opacity=0.9999);e=function(){try{if(a){c.gotoRewind&&(c.gotoRewind=!1,a.init());var d=c.stageWidth?c.stageWidth:a.width,s=c.stageHeight?c.stageHeight:
a.height,p=c.screenWidth?c.screenWidth:g.innerWidth,k=c.screenHeight?c.screenHeight:g.innerHeight,y=p/k,n=d/s;w&&(g.innerWidth>g.screen.width&&(p=g.screen.width),g.innerHeight>g.screen.height&&(k=g.screen.height));if(I!==p||x!==k){q=d;r=s;h.fitForWidth?(q=Math.round(p),r=Math.round(p*s/d)):h.fitForHeight?(q=Math.round(k*d/s),r=Math.round(k)):f.fitToScreen&&(y>n?(q=k/s*d,r=k):(q=p,r=p/d*s));s=d=0;d=-1==c.stageHAlign?0:1==c.stageHAlign?Math.round(p-q):Math.round((p-q)/2);s=-1==c.stageVAlign?0:1==c.stageVAlign?
Math.round(k-r):Math.round((k-r)/2);l.width=c.stageWidth?c.stageWidth:l.width;l.height=c.stageHeight?c.stageHeight:l.height;b.style.left=l.style.left=d+"px";b.style.top=l.style.top=s+"px";b.style.width=l.style.width=q+"px";b.style.height=l.style.height=r+"px";b.width=l.width=Math.floor(q*B);b.height=l.height=Math.floor(r*B);f.fitToScreen?y<n?(v=q/l.width,a.property.clear(),a.fitForWidth(l.width,l.height)):(v=r/l.height,a.property.clear(),a.fitForHeight(l.width,l.height)):h.fitForWidth?(v=q/l.width,
a.property.clear(),a.fitForWidth(l.width,l.height)):(v=r/l.height,a.property.clear(),a.fitForHeight(l.width,l.height));"useWebkitCSSRenderer"===c.getRenderer()&&a.setTextScale(window.devicePixelRatio);a.property.moveTo(0,0);if(c.displayDivId){var m=document.getElementById(c.displayDivId);f.fitToScreen?(m.style.width=p+"px",m.style.height=k+"px"):(m.style.width=q+"px",m.style.height=r+"px")}I=p;x=k}var u=g.performance.now(),p=u-E;E=u;c.pausing||(a.exec(p/1E3),a.render());g.requestAnimationFrame(e);
0===F%60&&(G=Math.round(6E4/(u-z)),z=u,F=0);if(c.debug||f.debug)document.getElementById("lwf_info"+f.debugInfoElementId).innerHTML=G+"fps";F++;c.setCurrentFPS(G)}}catch(t){c.handleException_(t,f)}};d=function(b){try{if(c.isPreventDefaultEnabled&&b.preventDefault(),a){var d,e,h=l.getBoundingClientRect();if(t){var g=b.touches[0];d=g.pageX;e=g.pageY}else d=b.clientX,e=b.clientY;t?(d=d-h.left-window.scrollX,e=e-h.top-window.scrollY):(d-=h.left,e-=h.top);d/=v;e/=v;a.inputPoint(d,e)}}catch(k){c.handleException_(k,
f)}};y=function(b){try{if(c.isPreventDefaultEnabled&&b.preventDefault(),a){var d,e,h=l.getBoundingClientRect();if(t){var g=b.touches[0];d=g.pageX;e=g.pageY}else d=b.clientX,e=b.clientY;t?(d=d-h.left-window.scrollX,e=e-h.top-window.scrollY):(d-=h.left,e-=h.top);d/=v;e/=v;a.inputPoint(d,e);a.inputPress()}}catch(k){c.handleException_(k,f)}};k=function(b){try{c.isPreventDefaultEnabled&&b.preventDefault(),a&&a.inputRelease()}catch(d){c.handleException_(d,f)}};u=function(b){try{a&&g.location.reload(!0)}catch(d){c.handleException_(d,
f)}};g.requestAnimationFrame(e);t?(w&&(H||/ SC-0/.test(n))&&document.body.addEventListener("touchstart",function(){}),D&&(c.debug||f.debug)&&b.addEventListener("gestureend",u,!1),b.addEventListener("touchmove",d,!1),b.addEventListener("touchstart",y,!1),b.addEventListener("touchend",k,!1)):(b.addEventListener("mousemove",d,!1),b.addEventListener("mousedown",y,!1),b.addEventListener("mouseup",k,!1));_.each(f.buttonEventMap,function(b,c){_.isFunction(b)?b={release:b}:_.each(b,function(a,b){if(!_.isFunction(a))throw Error("button event ["+
b+"@"+c+"] is not a function!");});a.setButtonEventHandler(c,b)});var A={},C=function(a,b){A.hasOwnProperty(a)||(A[a]=[]);A[a].push(b)};_.isObject(f.fsCommandMap)&&_.each(f.fsCommandMap,function(a,b){_.isFunction(a)&&C(b,a)});_.isObject(f.pageTransitionMap)&&_.each(f.pageTransitionMap,function(a,b){_.isString(a)?C(b,function(){document.location.href=a}):_.isFunction(a)&&C(b,function(){a(b)})});C=null;_.each(A,function(b,c){a.setEventHandler(c,function(a,c){for(var d=b.length,e=0;e<d;++e)b[e](a,c)})});
A=null}else c.handleLoadError_(this,f)};k.prototype.playLWF=function(a,h){var f=a.getAttribute("data-lwf-display_setting");f&&(f=JSON.parse(f),this.setDisplaySetting(f));f=g.LWF;this.getRenderer()||this.setRenderer(this.autoSelectRenderer_());var c=this.getRenderer();if(c)f[c]();else throw Error("Renderer parameters are not properly set");f=f.ResourceCache.get();this.debug&&(g.LWFLOADER_ENABLE_DEBUG=!0);var b={};b.onload=this.onLoad;null!==this.backgroundColor?b.setBackgroundColor=this.backgroundColor:
b.useBackgroundColor=!0;b.fitForHeight=!1;b.fitForWidth=!1;"fitForWidth"===this.resizeMode?b.fitForWidth=!0:"fitForHeight"===this.resizeMode?b.fitForHeight=!0:"fitToScreen"===this.resizeMode&&(this.fitToScreen=!0);b.fitToScreen=this.fitToScreen;b.worker=x;w&&/ (SC-0|Galaxy Nexus|SH-0)/.test(n)&&"useWebkitCSSRenderer"===c&&(b.quirkyClearRect=!0);w&&(b.use3D=!1);b.privateData={};b.pos=null;b.imageMap={};b.soundMap={};b.pageTransitionMap={};b.buttonEventMap={};b.fsCommandMap={};b.handler={};b.callback=
{};b.lwfMap=null;for(var e=function(a){return a.charAt(1).toUpperCase()},d=0;d<a.attributes.length;d++){var k=a.attributes[d];if(k.name&&0===k.name.indexOf("data-lwf-")){var m=k.name.slice(9),m=m.replace(/_./g,e);if("displaySetting"!==m){k=k.value;try{"{"===k.charAt(0)&&(k=JSON.parse(k))}catch(u){}b[m]=k}}}2===g.devicePixelRatio&&this.useLargeImage&&(b.imageSuffix="_@2x");b.hasOwnProperty("lwf")||(e=a.getAttribute("data-lwf"),_.isString(e)&&(b.lwf=e));b.hasOwnProperty("name")&&(b.lwf=b.name);_.isObject(h)&&
_.extend(b,h);0<this.initializeHooks.length&&_.each(this.initializeHooks,_.bind(function(c){if(_.isFunction(c)){c=c.call(this,a);for(var d in c)c.hasOwnProperty(d)&&_.extend(b[d],c[d])}},this));this.initializeHooks=[];if(!b.hasOwnProperty("lwf"))throw Error("[LWF] no LWF input");e={};e.debugInfoElementId=++z;e.setting=b;e.loader=this;e.debug=!1;e.soundMap=null;e.pageTransitionMap=null;e.buttonEventMap=null;e.fsCommandMap=null;e.handler=null;e.callback=null;e.stageEventReceiver=null;e.lwfMap=null;
e.debug=this.debug;b.privateData.hasOwnProperty("lwfLoader")||(b.privateData.lwfLoader=this);b.imageMap=this.getImageMapper_(b.imageMap);_.isEmpty(b.soundMap)||(e.soundMap=b.soundMap);delete b.soundMap;_.isObject(b.pageTransitionMap)&&(e.pageTransitionMap=b.pageTransitionMap);delete b.pageTransitionMap;e.buttonEventMap=b.buttonEventMap;delete b.buttonEventMap;_.isEmpty(b.fsCommandMap)||(e.fsCommandMap=b.fsCommandMap);delete b.fsCommandMap;_.isEmpty(b.handler)||(e.handler=b.handler);delete b.handler;
e.callback=b.callback;delete b.callback;e.lwfMap=b.lwfMap;delete b.lwfMap;e.fitToScreen=b.fitToScreen;delete b.fitToScreen;this.isLwfsEnvironment_()&&(d=b.prefix?b.prefix+b.lwf:b.lwf,b.prefix=d.slice(0,d.lastIndexOf("/")+1),delete b.imagePrefix,b.lwf=d.slice(d.lastIndexOf("/")+1));d={position:"absolute",top:0,left:0};_.extend(d,b.pos);delete b.pos;if("static"===a.style.position||""===a.style.position)a.style.position="relative";c=J(c);c.style.position=d.position;c.style.top=d.top+"px";c.style.left=
d.left+"px";c.style.zIndex=a.style.zIndex+1;a.appendChild(c);m=null;t?(m=document.createElement("div"),m.style.position="absolute",m.style.top=d.top+"px",m.style.left=d.left+"px",m.style.zIndex=c.style.zIndex+1,a.appendChild(m)):m=c;b.stage=c;e.stageEventReceiver=m;if(this.debug||e.debug)c=document.createElement("div"),c.id="lwf_info"+z,c.style.position=d.position,c.style.top=d.top+"px",c.style.left=d.left+"px",c.style.color="white",c.style.zIndex=1E4,a.appendChild(c);if(b.lwf){e.useLwfJs=/\.lwf.js(\?.*)?$/.test(b.lwf);
if(b.hasOwnProperty("_loaderData"))throw Error("cannot use '_loaderData' property that used by lwf-loader!");b.privateData._loaderData=e;f.loadLWF(b)}else console.error("[LWF] no LWF input")};k.prototype.requestLWF_=function(a,h,f,c,b){var e={},d={},e={};if(this.isLwfsEnvironment_()){d=_.clone(window.testlwf_settings);d.prefix?e=d.prefix+h+"/_/":(e=document.location.pathname,e=e.replace(a.name,h),e=e.slice(0,e.lastIndexOf("/")+1)+"_/");d.prefix=e;delete d.imagePrefix;e=this.getLwfPath_(h);if(!e)return console.error("[LWF] no LWF input"),
b("no LWF input",null),null;d.lwf=e;d.parentLWF=a;d.stage=a.stage;d.worker=x;d.active=!1;f&&(d.imageMap=this.getImageMapper_(f));c&&(d.privateData=c);d.onload=function(a){var c={},c=_.isUndefined(this.privateData)||_.isUndefined(this.privateData.lwfLoader)?new k:this.privateData.lwfLoader;return a?b(null,a):(c.handleLoadError_(this),b(this.error,a))}}else{d=a.privateData;if("undefined"===typeof d)return console.error("[LWF] Parent private data is not found"),b("no parents data found",null),null;var g=
_.clone(d._loaderData);if("undefined"===typeof g)return console.error("[LWF] Parent Loader data is not found"),b("no loader parameters to inherit"),null;d=_.clone(g.setting);this.useAbsImagePath?d.imagePrefix="":this.useDefaultImgPath&&(d.imagePrefix=h+"/");d.fitForHeight=d.fitForWidth=!1;g.setting=d;if(this.isLwfsLoaderEnvironment_())e=document.location.pathname,e=e.replace(a.name,h),e=e.slice(0,e.lastIndexOf("/")+1)+"_/",d.prefix=e,delete d.imagePrefix,e=this.getLwfPath_(h);else{e=null;try{e=this.getLwfMapper_(g)(h)}catch(m){this.handleException_(m,
g)}}if(!e)return console.error("[LWF] no LWF input"),b("no LWF input",null),null;d.lwf=e;g.useLwfJs&&(d.lwf+=".js");d.parentLWF=a;d.stage=a.stage;d.worker=x;d.active=!1;f&&(d.imageMap=this.getImageMapper_(f));c&&(c._loaderData=g,d.privateData=c,c.prefix&&(d.prefix=c.prefix),c.imagePrefix&&(d.imagePrefix=c.imagePrefix));d.onload=function(a){var c=g.loader;return a?b(null,a):(c.handleLoadError_(this,g),b(this.error,a))}}return d};k.prototype.requestLWF=function(a,g,f,c,b){a=this.requestLWF_(a,g,f,c,
b);_.isNull(a)||this.requests.push(a)};k.prototype.loadLWF=function(a,h,f,c,b){a=this.requestLWF_(a,h,f,c,b);_.isNull(a)||g.LWF.ResourceCache.get().loadLWF(a)};k.prototype.loadLWFs=function(a){g.LWF.ResourceCache.get().loadLWFs(this.requests,a);this.requests=[]};g.LwfLoader=k})(window);
