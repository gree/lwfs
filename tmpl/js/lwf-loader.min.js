(function(g){function I(a){a="useCanvasRenderer"===a||"useWebGLRenderer"===a?document.createElement("canvas"):document.createElement("div");a.width=a.height=0;return a}function i(){this.initializeHooks=[];this.requests=[];this.pausing=!1;this.loadingCounter=0;this.debug=!1;this.resizeMode=this.backgroundColor=null;this.fitToScreen=!1;this.displayDivId=null;this.screenHeight=this.screenWidth=this.stageHeight=this.stageWidth=0;this.stageVAlign=this.stageHAlign=-1;this.useLargeImage=!1;this.isPreventDefaultEnabled=
B||/Android *(4|3)\..*/.test(l);this.rootOffset={x:0,y:0};var a=null,h=0;this.getRenderer=function(){return a};this.setRenderer=function(f){if(a)throw Error("cannot use multiple renderer! LWF has been initialized for "+a+" renderer.");"canvas"===f?f="useCanvasRenderer":"webkitcss"===f?f="useWebkitCSSRenderer":"webgl"===f&&(f="useWebGLRenderer");f&&f.match(/use.+Renderer/i)&&(a=f)};this.getCurrentFPS=function(){isNaN(h)&&console.error("[LWF] FPS is not properly defined");return h};this.setCurrentFPS=
function(a){isNaN(a)&&console.error("[LWF] FPS is not properly defined");h=a};return this}var l=navigator.userAgent,B=/iP(ad|hone|od)/.test(l),t=/Android/.test(l),u=B||t,G=/Chrome/.test(l),v=!t||G,x=0;"undefined"===typeof g.performance&&(g.performance={});g.performance.now=g.performance.now||g.performance.webkitNow||g.performance.mozNow||g.performance.oNow||g.performance.msNow||Date.now;g.requestAnimationFrame=g.requestAnimationFrame||g.webkitRequestAnimationFrame||g.mozRequestAnimationFrame||g.oRequestAnimationFrame||
g.msRequestAnimationFrame;(void 0===g.requestAnimationFrame||/iP(ad|hone|od).*OS 6/.test(l))&&function(){var a=1E3/60,h=g.performance.now();g.requestAnimationFrame=function(f){var c=g.performance.now()-h;return g.setTimeout(function(){h=g.performance.now();f()},a-(c>a?c%a:c))}}();i.prototype.isLwfsEnvironment_=function(){return g.testlwf_settings&&!this.isLwfsLoaderEnvironment_()};i.prototype.isLwfsLoaderEnvironment_=function(){return g.lwfs_loader_mode};i.prototype.setPreventDefaultBehaviour=function(a){this.isPreventDefaultEnabled=
a};i.prototype.addInitializeHook=function(a){_.isFunction(a)&&this.initializeHooks.push(a)};i.prototype.pause=function(){this.pausing=!0};i.prototype.resume=function(){this.pausing=!1};i.prototype.getLwfMapper_=function(a){if(null===a.lwfMap)return _.bind(this.getLwfPath_,this);var h=a.lwfMap;if(_.isObject(h))return _.isFunction(h)?h:function(a){var c=a;h.hasOwnProperty(a)&&(c=h[a]);/\.lwf$/.test(c)||(c+=".lwf");return c};throw Error("unsupported lwfMap");};i.prototype.getLwfPath_=function(a){var h=
a;0<=a.indexOf("/")&&(h=a.substring(a.lastIndexOf("/")+1));return this.isLwfsEnvironment_()||this.isLwfsLoaderEnvironment_()?h+".lwf":a+"/_/"+h+".lwf"};i.prototype.getImageMapper_=function(a){return _.isFunction(a)?a:function(h){return a[h]?a[h]:h}};i.prototype.autoSelectRenderer_=function(){return/iP(ad|hone|od).*OS 4/.test(l)||(/Android 2\.1/.test(l)||/Android 2\.3\.[5-7]/.test(l))||/Android 4/.test(l)&&!/Chrome/.test(l)?"useWebkitCSSRenderer":"useCanvasRenderer"};i.prototype.setDisplaySetting=
function(a){a.renderer&&this.setRenderer(a.renderer);this.resizeMode=a.resizeMode||this.resizeMode;this.displayDivId=a.displayDivId||this.displayDivId;this.stageWidth=a.stageWidth||this.stageWidth;this.stageHeight=a.stageHeight||this.stageHeight;this.screenWidth=a.screenWidth||this.screenWidth;this.screenHeight=a.screenHeight||this.screenHeight;this.stageHAlign="undefined"!==typeof a.stageHAlign?a.stageHAlign:this.stageHAlign;this.stageVAlign="undefined"!==typeof a.stageHAlign?a.stageVAlign:this.stageVAlign;
this.useLargeImage=a.useLargeImage||this.useLargeImage};i.prototype.handleException_=function(a,h){var f=h.pageTransitionMap,c=null;f.hasOwnProperty("error")?c=f.error:0<_.size(f)&&(c=_.find(f,function(){return!0}));f=h.handler;null===f||void 0===f.exception?confirm("LWF exception. \n"+a.stack+"\n reload?")&&location.reload():_.isFunction(f.exception)&&f.exception(a,c);console.error("[LWF] exception: %s",a.stack)};i.prototype.handleLoadError_=function(a,h){var f=h.pageTransitionMap,c=null;f.hasOwnProperty("error")?
0<_.size(f)&&(c=_.find(f,function(){return!0})):c=f.error;f=h.handler;null===f||void 0===f.loadError?confirm("LWF load error. \n reload?")&&location.reload():_.isFunction(f.loadError)&&f.loadError(a,c);console.error("[LWF] load error: %o",a.error);console.error("[LWF] loaded count: %d/%d",a.loadedCount,a.total)};i.prototype.onLoad=function(a){var h=this,f=h.privateData._loaderData,c=f.loader,b=f.stageEventReceiver;h.privateData=null;if(a){if(_.isFunction(f.callback.onLoad))f.callback.onLoad(a);var e,
d,w,i,y,j=this.stage,H=0,v=0,s=1,n=0,p=0,C=g.performance.now(),D=0,x=C,E=0;a.rootMovie.moveTo(c.rootOffset.x,c.rootOffset.y);g.lwfs_loader_mode||(a.width=c.stageWidth?c.stageWidth:a.width,a.height=c.stageHeight?c.stageHeight:a.height);g.lwfWidth=a.width;g.lwfHeight=a.height;var F=g.devicePixelRatio;"useWebkitCSSRenderer"===c.getRenderer()&&(F=1);e=function(){try{if(a){var d=c.stageWidth?c.stageWidth:a.width,r=c.stageHeight?c.stageHeight:a.height,m=c.screenWidth?c.screenWidth:g.innerWidth,q=c.screenHeight?
c.screenHeight:g.innerHeight,i=m/q,w=d/r;t&&(g.innerWidth>g.screen.width&&(m=g.screen.width),g.innerHeight>g.screen.height&&(q=g.screen.height));if(H!==m||v!==q){n=d;p=r;h.fitForWidth?(n=Math.round(m),p=Math.round(m*r/d)):h.fitForHeight?(n=Math.round(q*d/r),p=Math.round(q)):f.fitToScreen&&(i>w?(n=d*(q/r),p=q):(n=m,p=r*(m/d)));r=d=0;d=-1==c.stageHAlign?0:1==c.stageHAlign?Math.round(m-n):Math.round((m-n)/2);r=-1==c.stageVAlign?0:1==c.stageVAlign?Math.round(q-p):Math.round((q-p)/2);j.width=c.stageWidth?
c.stageWidth:j.width;j.height=c.stageHeight?c.stageHeight:j.height;b.style.left=j.style.left=d+"px";b.style.top=j.style.top=r+"px";b.style.width=j.style.width=n+"px";b.style.height=j.style.height=p+"px";b.width=j.width=Math.floor(n*F);b.height=j.height=Math.floor(p*F);f.fitToScreen?i<w?(s=n/j.width,a.property.clear(),a.fitForWidth(j.width,j.height)):(s=p/j.height,a.property.clear(),a.fitForHeight(j.width,j.height)):h.fitForWidth?(s=n/j.width,a.property.clear(),a.fitForWidth(j.width,j.height)):(s=
p/j.height,a.property.clear(),a.fitForHeight(j.width,j.height));a.property.moveTo(0,0);if(c.displayDivId){var k=document.getElementById(c.displayDivId);f.fitToScreen?(k.style.width=m+"px",k.style.height=q+"px"):(k.style.width=n+"px",k.style.height=p+"px")}H=m;v=q}var l=g.performance.now(),m=l-C;C=l;c.pausing||(a.exec(m/1E3),a.render());g.requestAnimationFrame(e);0===D%60&&(E=Math.round(6E4/(l-x)),x=l,D=0);if(c.debug||f.debug)document.getElementById("lwf_info"+f.debugInfoElementId).innerHTML=E+"fps";
D++;c.setCurrentFPS(E)}}catch(y){c.handleException_(y,f)}};d=function(b){try{if(c.isPreventDefaultEnabled&&b.preventDefault(),a){var d,e,h=j.getBoundingClientRect();if(u){var g=b.touches[0];d=g.pageX;e=g.pageY}else d=b.clientX,e=b.clientY;u?(d=d-h.left-window.scrollX,e=e-h.top-window.scrollY):(d-=h.left,e-=h.top);d/=s;e/=s;a.inputPoint(d,e)}}catch(i){c.handleException_(i,f)}};w=function(b){try{if(c.isPreventDefaultEnabled&&b.preventDefault(),a){var d,e,h=j.getBoundingClientRect();if(u){var g=b.touches[0];
d=g.pageX;e=g.pageY}else d=b.clientX,e=b.clientY;u?(d=d-h.left-window.scrollX,e=e-h.top-window.scrollY):(d-=h.left,e-=h.top);d/=s;e/=s;a.inputPoint(d,e);a.inputPress()}}catch(i){c.handleException_(i,f)}};i=function(b){try{c.isPreventDefaultEnabled&&b.preventDefault(),a&&a.inputRelease()}catch(d){c.handleException_(d,f)}};y=function(b){try{a&&g.location.reload(!0)}catch(d){c.handleException_(d,f)}};g.requestAnimationFrame(e);u?(t&&(G||/ SC-0/.test(l))&&document.body.addEventListener("touchstart",function(){}),
B&&(c.debug||f.debug)&&b.addEventListener("gestureend",y,!1),b.addEventListener("touchmove",d,!1),b.addEventListener("touchstart",w,!1),b.addEventListener("touchend",i,!1)):(b.addEventListener("mousemove",d,!1),b.addEventListener("mousedown",w,!1),b.addEventListener("mouseup",i,!1));_.each(f.buttonEventMap,function(b,c){_.isFunction(b)?b={release:b}:_.each(b,function(a,b){if(!_.isFunction(a))throw Error("button event ["+b+"@"+c+"] is not a function!");});a.setButtonEventHandler(c,b)});var z={},A=
function(a,b){z.hasOwnProperty(a)||(z[a]=[]);z[a].push(b)};_.isObject(f.fsCommandMap)&&_.each(f.fsCommandMap,function(a,b){_.isFunction(a)&&A(b,a)});_.isObject(f.pageTransitionMap)&&_.each(f.pageTransitionMap,function(a,b){_.isString(a)?A(b,function(){document.location.href=a}):_.isFunction(a)&&A(b,function(){a(b)})});A=null;_.each(z,function(b,c){a.setEventHandler(c,function(a,c){for(var d=b.length,e=0;e<d;++e)b[e](a,c)})});z=null}else c.handleLoadError_(this,f)};i.prototype.playLWF=function(a,h){var f=
a.getAttribute("data-lwf-display_setting");f&&(f=JSON.parse(f),this.setDisplaySetting(f));f=g.LWF;this.getRenderer()||this.setRenderer(this.autoSelectRenderer_());var c=this.getRenderer();if(c)f[c]();else throw Error("Renderer parameters are not properly set");f=f.ResourceCache.get();this.debug&&(g.LWFLOADER_ENABLE_DEBUG=!0);var b={};b.onload=this.onLoad;this.backgroundColor?b.setBackgroundColor=this.backgroundColor:b.useBackgroundColor=!0;b.fitForHeight=!1;b.fitForWidth=!1;"fitForWidth"===this.resizeMode?
b.fitForWidth=!0:"fitForHeight"===this.resizeMode?b.fitForHeight=!0:"fitToScreen"===this.resizeMode&&(this.fitToScreen=!0);b.fitToScreen=this.fitToScreen;b.worker=v;t&&(/ (SC-0|Galaxy Nexus)/.test(l)&&"useWebkitCSSRenderer"===c)&&(b.quirkyClearRect=!0);t&&(b.use3D=!1);b.privateData={};b.pos=null;b.imageMap={};b.soundMap={};b.pageTransitionMap={};b.buttonEventMap={};b.fsCommandMap={};b.handler={};b.callback={};b.lwfMap=null;for(var e=function(a){return a.charAt(1).toUpperCase()},d=0;d<a.attributes.length;d++){var i=
a.attributes[d];if(i.name&&0===i.name.indexOf("data-lwf-")){var k=i.name.slice(9),k=k.replace(/_./g,e);if("displaySetting"!==k){i=i.value;try{"{"===i.charAt(0)&&(i=JSON.parse(i))}catch(y){}b[k]=i}}}2===g.devicePixelRatio&&this.useLargeImage&&(b.imageSuffix="_@2x");b.hasOwnProperty("lwf")||(e=a.getAttribute("data-lwf"),_.isString(e)&&(b.lwf=e));b.hasOwnProperty("name")&&(b.lwf=b.name);_.isObject(h)&&_.extend(b,h);0<this.initializeHooks.length&&_.each(this.initializeHooks,_.bind(function(c){if(_.isFunction(c)){c=
c.call(this,a);for(var d in c)c.hasOwnProperty(d)&&_.extend(b[d],c[d])}},this));this.initializeHooks=[];if(!b.hasOwnProperty("lwf"))throw Error("[LWF] no LWF input");e={};e.debugInfoElementId=++x;e.setting=b;e.loader=this;e.debug=!1;e.soundMap=null;e.pageTransitionMap=null;e.buttonEventMap=null;e.fsCommandMap=null;e.handler=null;e.callback=null;e.stageEventReceiver=null;e.lwfMap=null;e.debug=this.debug;b.privateData.hasOwnProperty("lwfLoader")||(b.privateData.lwfLoader=this);b.imageMap=this.getImageMapper_(b.imageMap);
_.isEmpty(b.soundMap)||(e.soundMap=b.soundMap);delete b.soundMap;_.isObject(b.pageTransitionMap)&&(e.pageTransitionMap=b.pageTransitionMap);delete b.pageTransitionMap;e.buttonEventMap=b.buttonEventMap;delete b.buttonEventMap;_.isEmpty(b.fsCommandMap)||(e.fsCommandMap=b.fsCommandMap);delete b.fsCommandMap;_.isEmpty(b.handler)||(e.handler=b.handler);delete b.handler;e.callback=b.callback;delete b.callback;e.lwfMap=b.lwfMap;delete b.lwfMap;e.fitToScreen=b.fitToScreen;delete b.fitToScreen;this.isLwfsEnvironment_()&&
(d=b.prefix?b.prefix+b.lwf:b.lwf,b.prefix=d.slice(0,d.lastIndexOf("/")+1),delete b.imagePrefix,b.lwf=d.slice(d.lastIndexOf("/")+1));d={position:"absolute",top:0,left:0};_.extend(d,b.pos);delete b.pos;if("static"===a.style.position||""===a.style.position)a.style.position="relative";c=I(c);c.style.position=d.position;c.style.top=d.top+"px";c.style.left=d.left+"px";c.style.zIndex=a.style.zIndex+1;a.appendChild(c);k=null;u?(k=document.createElement("div"),k.style.position="absolute",k.style.top=d.top+
"px",k.style.left=d.left+"px",k.style.zIndex=c.style.zIndex+1,a.appendChild(k)):k=c;b.stage=c;e.stageEventReceiver=k;if(this.debug||e.debug)c=document.createElement("div"),c.id="lwf_info"+x,c.style.position=d.position,c.style.top=d.top+"px",c.style.left=d.left+"px",c.style.color="white",c.style.zIndex=1E4,a.appendChild(c);if(b.lwf){e.useLwfJs=/\.lwf.js(\?.*)?$/.test(b.lwf);if(b.hasOwnProperty("_loaderData"))throw Error("cannot use '_loaderData' property that used by lwf-loader!");b.privateData._loaderData=
e;f.loadLWF(b)}else console.error("[LWF] no LWF input")};i.prototype.requestLWF_=function(a,h,f,c,b){var e={},d={},e={};if(this.isLwfsEnvironment_()){d=_.clone(window.testlwf_settings);d.prefix?e=d.prefix+h+"/_/":(e=document.location.pathname,e=e.replace(a.name,h),e=e.slice(0,e.lastIndexOf("/")+1)+"_/");d.prefix=e;delete d.imagePrefix;e=this.getLwfPath_(h);if(!e)return console.error("[LWF] no LWF input"),b("no LWF input",null),null;d.lwf=e;d.parentLWF=a;d.stage=a.stage;d.worker=v;d.active=!1;f&&(d.imageMap=
this.getImageMapper_(f));c&&(d.privateData=c);d.onload=function(a){var c=this.privateData.lwfLoader;return!a?(c.handleLoadError_(this),b(this.error,a)):b(null,a)}}else{d=a.privateData;if("undefined"===typeof d)return console.error("[LWF] Parent private data is not found"),b("no parents data found",null),null;var g=_.clone(d._loaderData);if("undefined"===typeof g)return console.error("[LWF] Parent Loader data is not found"),b("no loader parameters to inherit"),null;d=_.clone(g.setting);d.fitForHeight=
d.fitForWidth=!1;g.setting=d;if(this.isLwfsLoaderEnvironment_())e=document.location.pathname,e=e.replace(a.name,h),e=e.slice(0,e.lastIndexOf("/")+1)+"_/",d.prefix=e,delete d.imagePrefix,e=this.getLwfPath_(h);else{e=null;try{e=this.getLwfMapper_(g)(h)}catch(i){this.handleException_(i,g)}}if(!e)return console.error("[LWF] no LWF input"),b("no LWF input",null),null;d.lwf=e;g.useLwfJs&&(d.lwf+=".js");d.parentLWF=a;d.stage=a.stage;d.worker=v;d.active=!1;f&&(d.imageMap=this.getImageMapper_(f));c&&(c._loaderData=
g,d.privateData=c,c.prefix&&(d.prefix=c.prefix),c.imagePrefix&&(d.imagePrefix=c.imagePrefix));d.onload=function(a){var c=g.loader;return!a?(c.handleLoadError_(this,g),b(this.error,a)):b(null,a)}}return d};i.prototype.requestLWF=function(a,g,f,c,b){a=this.requestLWF_(a,g,f,c,b);_.isNull(a)||this.requests.push(a)};i.prototype.loadLWF=function(a,h,f,c,b){a=this.requestLWF_(a,h,f,c,b);_.isNull(a)||g.LWF.ResourceCache.get().loadLWF(a)};i.prototype.loadLWFs=function(a){g.LWF.ResourceCache.get().loadLWFs(this.requests,
a);this.requests=[]};g.LwfLoader=i})(window);
