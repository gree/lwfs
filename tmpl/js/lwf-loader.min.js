(function(d){function L(a){a="useCanvasRenderer"===a||"useWebGLRenderer"===a?document.createElement("canvas"):document.createElement("div");a.width=a.height=0;return a}function h(){this.lwfInstances={};this.lwfLoaderUid=0;this.timers={};this.initializeHooks=[];this.requests=[];this.gotoRewind=this.pausing=!1;this.loadingCounter=0;this.debug=!1;this.resizeMode=this.backgroundColor=null;this.fitToScreen=!1;this.displayDivId=null;this.screenHeight=this.screenWidth=this.stageHeight=this.stageWidth=0;
this.stageVAlign=this.stageHAlign=-1;this.useDefaultImgPath=this.useAbsImagePath=this.useWebGL=this.useLargeImage=!1;this.isPreventDefaultEnabled=F||/Android *(4|3)\..*/.test(k);this.rootOffset={x:0,y:0};var a=null,d=0;this.getRenderer=function(){return a};this.setRenderer=function(f){if(a)throw Error("cannot use multiple renderer! LWF has been initialized for "+a+" renderer.");"canvas"===f?f="useCanvasRenderer":"webkitcss"===f?f="useWebkitCSSRenderer":"webgl"===f&&(f="useWebGLRenderer");f&&f.match(/use.+Renderer/i)&&
(a=f)};this.getCurrentFPS=function(){isNaN(d)&&console.error("[LWF] FPS is not properly defined");return d};this.setCurrentFPS=function(a){isNaN(a)&&console.error("[LWF] FPS is not properly defined");d=a};return this}var k=navigator.userAgent,F=/iP(ad|hone|od)/.test(k),x=/Android/.test(k),t=F||x,J=/Chrome/.test(k),y=!x||J,A=0;"undefined"===typeof d.performance&&(d.performance={});d.performance.now=d.performance.now||d.performance.webkitNow||d.performance.mozNow||d.performance.oNow||d.performance.msNow||
Date.now;d.requestAnimationFrame=d.requestAnimationFrame||d.webkitRequestAnimationFrame||d.mozRequestAnimationFrame||d.oRequestAnimationFrame||d.msRequestAnimationFrame;d.cancelAnimationFrame=d.cancelAnimationFrame||d.webkitCancelAnimationFrame||d.webkitCancelRequestAnimationFrame||d.mozCancelAnimationFrame||d.oCancelAnimationFrame||d.msCancelAnimationFrame;(void 0===d.requestAnimationFrame||void 0===d.cancelAnimationFrame||/iP(ad|hone|od).*OS 6/.test(k))&&function(){var a=1E3/60,l=d.performance.now();
d.requestAnimationFrame=function(f){var g=d.performance.now()-l;return d.setTimeout(function(){l=d.performance.now();f()},a-(g>a?g%a:g))};d.cancelAnimationFrame=function(a){return d.clearTimeout(a)}}();h.prototype.isLwfsEnvironment_=function(){return d.testlwf_settings&&!this.isLwfsLoaderEnvironment_()};h.prototype.isLwfsLoaderEnvironment_=function(){return d.lwfs_loader_mode};h.prototype.setPreventDefaultBehaviour=function(a){this.isPreventDefaultEnabled=a};h.prototype.addInitializeHook=function(a){_.isFunction(a)&&
this.initializeHooks.push(a)};h.prototype.pause=function(){this.pausing=!0};h.prototype.resume=function(){this.pausing=!1};h.prototype.rewind=function(){this.gotoRewind=!0};h.prototype.getLwfMapper_=function(a){if(null===a.lwfMap)return _.bind(this.getLwfPath_,this);var d=a.lwfMap;if(_.isObject(d))return _.isFunction(d)?d:function(a){var g=a;d.hasOwnProperty(a)&&(g=d[a]);/\.lwf$/.test(g)||(g+=".lwf");return g};throw Error("unsupported lwfMap");};h.prototype.getLwfPath_=function(a){var d=a.replace(/\.lwf$/i,
"");0<=a.indexOf("/")&&(d=a.substring(a.lastIndexOf("/")+1));return this.isLwfsEnvironment_()||this.isLwfsLoaderEnvironment_()?d+".lwf":a+"/_/"+d+".lwf"};h.prototype.getImageMapper_=function(a){return _.isFunction(a)?a:function(d){return a[d]?a[d]:d}};h.prototype.autoSelectRenderer_=function(){if(this.useWebGL)for(var a=document.createElement("canvas"),d=["webgl","experimental-webgl","moz-webgl","webkit-3d"],f,g=0;g<d.length;g++)if(f=a.getContext(d[g]))return"useWebGLRenderer";return/iP(ad|hone|od).*OS 4/.test(k)||
/Android 2\.1/.test(k)||/Android 2\.3\.[5-7]/.test(k)||/Android 4/.test(k)&&!/Chrome/.test(k)?"useWebkitCSSRenderer":"useCanvasRenderer"};h.prototype.setDisplaySetting=function(a){a.renderer&&this.setRenderer(a.renderer);this.resizeMode=a.resizeMode||this.resizeMode;this.displayDivId=a.displayDivId||this.displayDivId;this.stageWidth=a.stageWidth||this.stageWidth;this.stageHeight=a.stageHeight||this.stageHeight;this.screenWidth=a.screenWidth||this.screenWidth;this.screenHeight=a.screenHeight||this.screenHeight;
this.stageHAlign="undefined"!==typeof a.stageHAlign?a.stageHAlign:this.stageHAlign;this.stageVAlign="undefined"!==typeof a.stageHAlign?a.stageVAlign:this.stageVAlign;this.useLargeImage=a.useLargeImage||this.useLargeImage};h.prototype.handleException_=function(a,d){var f=d.pageTransitionMap,g=null;f.hasOwnProperty("error")?g=f.error:0<_.size(f)&&(g=_.find(f,function(){return!0}));f=d.handler;null===f||void 0===f.exception?confirm("LWF exception. \n"+a.stack+"\n reload?")&&location.reload():_.isFunction(f.exception)&&
f.exception(a,g);console.error("[LWF] exception: %s",a.stack)};h.prototype.handleLoadError_=function(a,d){var f=d.pageTransitionMap,g=null;f.hasOwnProperty("error")?0<_.size(f)&&(g=_.find(f,function(){return!0})):g=f.error;f=d.handler;null===f||void 0===f.loadError?confirm("LWF load error. \n reload?")&&location.reload():_.isFunction(f.loadError)&&f.loadError(a,g);console.error("[LWF] load error: %o",a.error);console.error("[LWF] loaded count: %d/%d",a.loadedCount,a.total)};h.prototype.onLoad=function(a){var l=
a.privateData,f=l.lwfLoader;f.lwfInstances[f.lwfLoaderUid]=a;l.loaderUid=f.lwfLoaderUid++;var g=this,b=g.privateData._loaderData,c=b.loader,e=b.stageEventReceiver;g.privateData=null;if(a){if(_.isFunction(b.callback.onLoad))b.callback.onLoad(a);var h,m,u,z,C,n=this.stage,y=0,A=0,w=1,q=0,r=0,G=d.performance.now(),H=0,K=G,I=0;a.rootMovie.moveTo(c.rootOffset.x,c.rootOffset.y);d.lwfs_loader_mode||(a.width=c.stageWidth?c.stageWidth:a.width,a.height=c.stageHeight?c.stageHeight:a.height);d.lwfWidth=a.width;
d.lwfHeight=a.height;var D=d.devicePixelRatio;"useWebkitCSSRenderer"===c.getRenderer()&&(D=1);"useWebGLRenderer"===c.getRenderer()&&/ F-/.test(k)&&(D=2);"useWebkitCSSRenderer"===c.getRenderer()&&/Android 2\.3\.[5-7]/.test(k)&&/SH/.test(k)&&(this.stage.style.opacity=.9999);h=function(){try{if(a){c.gotoRewind&&(c.gotoRewind=!1,a.init());var f=c.stageWidth?c.stageWidth:a.width,v=c.stageHeight?c.stageHeight:a.height,p=c.screenWidth?c.screenWidth:d.innerWidth,l=c.screenHeight?c.screenHeight:d.innerHeight,
m=p/l,z=f/v;x&&(d.innerWidth>d.screen.width&&(p=d.screen.width),d.innerHeight>d.screen.height&&(l=d.screen.height));if(y!==p||A!==l){q=f;r=v;c.fitToScreen?m<z?(q=p,r=p/f*v):(q=l/v*f,r=l):g.fitForWidth?(q=Math.round(p),r=Math.round(p*v/f)):g.fitForHeight&&(q=Math.round(l*f/v),r=Math.round(l));v=f=0;f=-1==c.stageHAlign?0:1==c.stageHAlign?Math.round(p-q):Math.round((p-q)/2);v=-1==c.stageVAlign?0:1==c.stageVAlign?Math.round(l-r):Math.round((l-r)/2);e.style.left=n.style.left=f+"px";e.style.top=n.style.top=
v+"px";e.style.width=n.style.width=q+"px";e.style.height=n.style.height=r+"px";e.width=n.width=Math.floor(q*D);e.height=n.height=Math.floor(r*D);a.property.clear();c.fitToScreen?m<z?(w=q/n.width,a.fitForWidth(n.width,n.height)):(w=r/n.height,a.fitForHeight(n.width,n.height)):g.fitForWidth?(w=q/n.width,a.fitForWidth(n.width,n.height)):(w=r/n.height,a.fitForHeight(n.width,n.height));"useWebkitCSSRenderer"===c.getRenderer()&&a.setTextScale(window.devicePixelRatio);a.property.moveTo(0,0);if(c.displayDivId){var k=
document.getElementById(c.displayDivId);c.fitToScreen?(k.style.width=p+"px",k.style.height=l+"px"):(k.style.width=q+"px",k.style.height=r+"px")}y=p;A=l}var u=d.performance.now(),p=u-G;G=u;c.pausing||(a.exec(p/1E3),a.render());var t=a.privateData;t.lwfLoader.timers[t.loaderUid]=d.requestAnimationFrame(h);0===H%60&&(I=Math.round(6E4/(u-K)),K=u,H=0);if(c.debug||b.debug)document.getElementById("lwf_info"+b.debugInfoElementId).innerHTML=I+"fps";H++;c.setCurrentFPS(I)}}catch(C){c.handleException_(C,b)}};
m=function(d){try{if(c.isPreventDefaultEnabled&&d.preventDefault(),a){var e,f,g=n.getBoundingClientRect();if(t){var l=d.touches[0];e=l.pageX;f=l.pageY}else e=d.clientX,f=d.clientY;t?(e=e-g.left-window.scrollX,f=f-g.top-window.scrollY):(e-=g.left,f-=g.top);e/=w;f/=w;a.inputPoint(e,f)}}catch(h){c.handleException_(h,b)}};u=function(d){try{if(c.isPreventDefaultEnabled&&d.preventDefault(),a){var e,f,g=n.getBoundingClientRect();if(t){var l=d.touches[0];e=l.pageX;f=l.pageY}else e=d.clientX,f=d.clientY;t?
(e=e-g.left-window.scrollX,f=f-g.top-window.scrollY):(e-=g.left,f-=g.top);e/=w;f/=w;a.inputPoint(e,f);a.inputPress()}}catch(h){c.handleException_(h,b)}};z=function(d){try{c.isPreventDefaultEnabled&&d.preventDefault(),a&&a.inputRelease()}catch(e){c.handleException_(e,b)}};C=function(e){try{a&&d.location.reload(!0)}catch(f){c.handleException_(f,b)}};f.timers[l.loaderUid]=d.requestAnimationFrame(h);t?(x&&(J||/ SC-0/.test(k))&&document.body.addEventListener("touchstart",function(){}),F&&(c.debug||b.debug)&&
e.addEventListener("gestureend",C,!1),e.addEventListener("touchmove",m,!1),e.addEventListener("touchstart",u,!1),e.addEventListener("touchend",z,!1)):(e.addEventListener("mousemove",m,!1),e.addEventListener("mousedown",u,!1),e.addEventListener("mouseup",z,!1));_.each(b.buttonEventMap,function(b,c){_.isFunction(b)?b={release:b}:_.each(b,function(a,b){if(!_.isFunction(a))throw Error("button event ["+b+"@"+c+"] is not a function!");});a.setButtonEventHandler(c,b)});var B={},E=function(a,b){B.hasOwnProperty(a)||
(B[a]=[]);B[a].push(b)};_.isObject(b.fsCommandMap)&&_.each(b.fsCommandMap,function(a,b){_.isFunction(a)&&E(b,a)});_.isObject(b.pageTransitionMap)&&_.each(b.pageTransitionMap,function(a,b){_.isString(a)?E(b,function(){document.location.href=a}):_.isFunction(a)&&E(b,function(){a(b)})});E=null;_.each(B,function(b,c){a.setEventHandler(c,function(a,c){for(var d=b.length,e=0;e<d;++e)b[e](a,c)})});B=null}else c.handleLoadError_(this,b)};h.prototype.playLWF=function(a,l){var f=a.getAttribute("data-lwf-display_setting");
f&&(f=JSON.parse(f),this.setDisplaySetting(f));f=d.LWF;this.getRenderer()||this.setRenderer(this.autoSelectRenderer_());var g=this.getRenderer();if(g)f[g]();else throw Error("Renderer parameters are not properly set");f=f.ResourceCache.get();this.debug&&(d.LWFLOADER_ENABLE_DEBUG=!0);var b={};b.onload=this.onLoad;null!==this.backgroundColor?b.setBackgroundColor=this.backgroundColor:b.useBackgroundColor=!0;b.fitForHeight=!1;b.fitForWidth=!1;"fitForWidth"===this.resizeMode?b.fitForWidth=!0:"fitForHeight"===
this.resizeMode?b.fitForHeight=!0:"fitToScreen"===this.resizeMode&&(this.fitToScreen=!0);b.fitToScreen=this.fitToScreen;b.worker=y;x&&/ (SC-0|Galaxy Nexus|SH-0|SCL21)/.test(k)&&(b.quirkyClearRect=!0);x&&(b.use3D=!1);b.privateData={};b.pos=null;b.imageMap={};b.soundMap={};b.pageTransitionMap={};b.buttonEventMap={};b.fsCommandMap={};b.handler={};b.callback={};b.lwfMap=null;for(var c=function(a){return a.charAt(1).toUpperCase()},e=0;e<a.attributes.length;e++){var h=a.attributes[e];if(h.name&&0===h.name.indexOf("data-lwf-")){var m=
h.name.slice(9),m=m.replace(/_./g,c);if("displaySetting"!==m){h=h.value;try{"{"===h.charAt(0)&&(h=JSON.parse(h))}catch(u){}b[m]=h}}}2===d.devicePixelRatio&&this.useLargeImage&&(b.imageSuffix="_@2x");b.hasOwnProperty("lwf")||(c=a.getAttribute("data-lwf"),_.isString(c)&&(b.lwf=c));b.hasOwnProperty("name")&&(b.lwf=b.name);_.isObject(l)&&_.extend(b,l);0<this.initializeHooks.length&&_.each(this.initializeHooks,_.bind(function(c){if(_.isFunction(c)){c=c.call(this,a);for(var d in c)c.hasOwnProperty(d)&&
_.extend(b[d],c[d])}},this));this.initializeHooks=[];if(!b.hasOwnProperty("lwf"))throw Error("[LWF] no LWF input");c={};c.debugInfoElementId=++A;c.setting=b;c.loader=this;c.debug=!1;c.soundMap=null;c.pageTransitionMap=null;c.buttonEventMap=null;c.fsCommandMap=null;c.handler=null;c.callback=null;c.stageEventReceiver=null;c.lwfMap=null;c.debug=this.debug;b.privateData.hasOwnProperty("lwfLoader")||(b.privateData.lwfLoader=this);b.imageMap=this.getImageMapper_(b.imageMap);_.isEmpty(b.soundMap)||(c.soundMap=
b.soundMap);delete b.soundMap;_.isObject(b.pageTransitionMap)&&(c.pageTransitionMap=b.pageTransitionMap);delete b.pageTransitionMap;c.buttonEventMap=b.buttonEventMap;delete b.buttonEventMap;_.isEmpty(b.fsCommandMap)||(c.fsCommandMap=b.fsCommandMap);delete b.fsCommandMap;_.isEmpty(b.handler)||(c.handler=b.handler);delete b.handler;c.callback=b.callback;delete b.callback;c.lwfMap=b.lwfMap;delete b.lwfMap;c.fitToScreen=b.fitToScreen;delete b.fitToScreen;this.isLwfsEnvironment_()?(e=b.prefix?b.prefix+
b.lwf:b.lwf,b.prefix=e.slice(0,e.lastIndexOf("/")+1),delete b.imagePrefix,b.lwf=e.slice(e.lastIndexOf("/")+1)):b.lwf=this.getLwfMapper_(c)(b.lwf);e={position:"absolute",top:0,left:0};_.extend(e,b.pos);delete b.pos;if("static"===a.style.position||""===a.style.position)a.style.position="relative";g=L(g);g.style.position=e.position;g.style.top=e.top+"px";g.style.left=e.left+"px";g.style.zIndex=a.style.zIndex+1;a.appendChild(g);m=null;t?(m=document.createElement("div"),m.style.position="absolute",m.style.top=
e.top+"px",m.style.left=e.left+"px",m.style.zIndex=g.style.zIndex+1,a.appendChild(m)):m=g;b.stage=g;c.stageEventReceiver=m;if(this.debug||c.debug)g=document.createElement("div"),g.id="lwf_info"+A,g.style.position=e.position,g.style.top=e.top+"px",g.style.left=e.left+"px",g.style.color="white",g.style.zIndex=1E4,a.appendChild(g);if(b.lwf){c.useLwfJs=/\.lwf.js(\?.*)?$/.test(b.lwf);if(b.hasOwnProperty("_loaderData"))throw Error("cannot use '_loaderData' property that used by lwf-loader!");b.privateData._loaderData=
c;f.loadLWF(b)}else console.error("[LWF] no LWF input")};h.prototype.requestLWF_=function(a,d,f,g,b){var c={},e={},c={};if(this.isLwfsEnvironment_()){e=_.clone(window.testlwf_settings);e.prefix?c=e.prefix+d+"/_/":(c=document.location.pathname,c=c.replace(a.name,d),c=c.slice(0,c.lastIndexOf("/")+1)+"_/");e.prefix=c;delete e.imagePrefix;c=this.getLwfPath_(d);if(!c)return console.error("[LWF] no LWF input"),b("no LWF input",null),null;e.lwf=c;e.parentLWF=a;e.stage=a.stage;e.worker=y;e.active=!1;f&&(e.imageMap=
this.getImageMapper_(f));g&&(e.privateData=g);e.onload=function(a){var c={},c=_.isUndefined(this.privateData)||_.isUndefined(this.privateData.lwfLoader)?new h:this.privateData.lwfLoader;return a?b(null,a):(c.handleLoadError_(this),b(this.error,a))}}else{e=a.privateData;if("undefined"===typeof e)return console.error("[LWF] Parent private data is not found"),b("no parents data found",null),null;var k=_.clone(e._loaderData);if("undefined"===typeof k)return console.error("[LWF] Parent Loader data is not found"),
b("no loader parameters to inherit"),null;e=_.clone(k.setting);this.useAbsImagePath?e.imagePrefix="":this.useDefaultImgPath&&(e.imagePrefix=d+"/");e.fitForHeight=e.fitForWidth=!1;k.setting=e;if(this.isLwfsLoaderEnvironment_())c=document.location.pathname,c=c.replace(a.name,d),c=c.slice(0,c.lastIndexOf("/")+1)+"_/",e.prefix=c,delete e.imagePrefix,c=this.getLwfPath_(d);else{c=null;try{c=this.getLwfMapper_(k)(d)}catch(m){this.handleException_(m,k)}}if(!c)return console.error("[LWF] no LWF input"),b("no LWF input",
null),null;e.lwf=c;k.useLwfJs&&(e.lwf+=".js");e.parentLWF=a;e.stage=a.stage;e.worker=y;e.active=!1;f&&(e.imageMap=this.getImageMapper_(f));g&&(g._loaderData=k,e.privateData=g,g.prefix&&(e.prefix=g.prefix),g.imagePrefix&&(e.imagePrefix=g.imagePrefix));e.onload=function(a){var c=k.loader;return a?b(null,a):(c.handleLoadError_(this,k),b(this.error,a))}}return e};h.prototype.requestLWF=function(a,d,f,g,b){a=this.requestLWF_(a,d,f,g,b);_.isNull(a)||this.requests.push(a)};h.prototype.loadLWF=function(a,
h,f,g,b){a=this.requestLWF_(a,h,f,g,b);_.isNull(a)||d.LWF.ResourceCache.get().loadLWF(a)};h.prototype.loadLWFs=function(a){d.LWF.ResourceCache.get().loadLWFs(this.requests,a);this.requests=[]};h.prototype.unloadLWF=function(a){var h=a.privateData.loaderUid;delete this.lwfInstances[h];d.cancelAnimationFrame(this.timers[h]);delete this.timers[h];a.destroy()};d.LwfLoader=h})(window);
